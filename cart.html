<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購物車 | 一味烏魚子</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }

        a { text-decoration: none; color: inherit; }

        header {
            background: #fff;
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .cart-container {
            max-width: 1000px;
            margin: 3rem auto;
            padding: 2rem;
            background: #fff;
            min-height: 60vh;
        }

        h2 {
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 400;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        th {
            font-weight: 700;
        }

        .qty-control {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            font-size: 16px;
        }

        .checkout-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 2rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #eee;
        }

        .total-price {
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.8;
        }

        .btn-checkout {
            padding: 12px 30px;
            background: #000;
            color: #fff;
            border: none;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-continue {
            font-size: 0.9rem;
            color: #777;
        }

        #empty-msg {
            text-align: center;
            color: #999;
            margin-top: 2rem;
            display: none;
        }

        label { display:block; margin-top:1rem; }
        input, select {
            width:100%;
            padding:10px;
            margin-top:6px;
            border:1px solid #ccc;
        }
    </style>
</head>

<body>

<header>
    <a href="store.html" class="logo">一味烏魚子.</a>
    <div>購物車</div>
</header>

<div class="cart-container">
    <h2>您的購物車</h2>

    <table>
        <thead>
            <tr>
                <th width="40%">商品</th>
                <th width="20%">單價</th>
                <th width="20%">數量</th>
                <th width="20%">小計</th>
            </tr>
        </thead>
        <tbody id="cart-body"></tbody>
    </table>

    <p id="empty-msg">購物車目前是空的</p>

    <div class="checkout-section">
        <a href="store.html" class="btn-continue">← 繼續購物</a>

        <div class="total-price">
            商品小計：NT$ <span id="subtotal">0</span><br>
            運費：NT$ <span id="shipping-fee">0</span><br>
            <strong>總金額：NT$ <span id="grand-total">0</span></strong>
        </div>

        <button class="btn-checkout" onclick="openCheckout()">前往結帳</button>
    </div>

    <!-- 結帳資料 -->
    <div id="checkout-form" style="display:none;margin-top:2rem;border-top:2px solid #eee;padding-top:2rem;">
        <h2>填寫訂購資料</h2>

        <label>姓名 *</label>
        <input type="text" id="name">

        <label>手機 *</label>
        <input type="tel" id="phone">

        <label>取貨方式 *</label>
        <select id="shipType" onchange="toggleShip()">
            <option value="">請選擇</option>
            <option value="home">宅配</option>
            <option value="store">超商取貨</option>
        </select>

        <div id="address-fields" style="display:none;">
            <label>宅配地址 *</label>
            <input type="text" id="address">
        </div>

        <div id="store-fields" style="display:none;">
            <label>超商別</label>
            <select id="storeType">
                <option value="7-11">7-11</option>
                <option value="全家">全家</option>
            </select>

            <label>超商店名 *</label>
            <input type="text" id="storeName">
        </div>

        <label>付款方式 *</label>
        <select id="payType">
            <option value="">請選擇</option>
            <option value="bank">銀行轉帳</option>
            <option value="linepay">LINE Pay</option>
        </select>

        <button class="btn-checkout" style="margin-top:1.5rem;" onclick="submitOrder()">
            送出訂單，前往付款說明
        </button>
    </div>
</div>

<script>
function getCart() {
    return JSON.parse(localStorage.getItem("cart")) || [];
}

function saveCart(cart) {
    localStorage.setItem("cart", JSON.stringify(cart));
}

function calculateShipping(subtotal, shipType) {
    if (subtotal >= 1000) return 0;
    if (shipType === "store") return 60;
    if (shipType === "home") return 80;
    return 0;
}

function changeQty(index, delta) {
    const cart = getCart();
    cart[index].qty += delta;
    if (cart[index].qty <= 0) cart.splice(index, 1);
    saveCart(cart);
    renderCart();
}

function renderCart() {
    const cart = getCart();
    const body = document.getElementById("cart-body");
    const subtotalEl = document.getElementById("subtotal");
    const shippingEl = document.getElementById("shipping-fee");
    const totalEl = document.getElementById("grand-total");
    const emptyMsg = document.getElementById("empty-msg");

    body.innerHTML = "";
    let subtotal = 0;

    if (cart.length === 0) {
        emptyMsg.style.display = "block";
        subtotalEl.innerText = "0";
        shippingEl.innerText = "0";
        totalEl.innerText = "0";
        return;
    }

    emptyMsg.style.display = "none";

    cart.forEach((item, index) => {
        const itemTotal = item.price * item.qty;
        subtotal += itemTotal;

        body.innerHTML += `
            <tr>
                <td>${item.name}</td>
                <td>NT$ ${item.price}</td>
                <td>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="changeQty(${index}, -1)">−</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn" onclick="changeQty(${index}, 1)">＋</button>
                    </div>
                </td>
                <td>NT$ ${itemTotal}</td>
            </tr>
        `;
    });

    const shipType = document.getElementById("shipType").value;
    const shippingFee = calculateShipping(subtotal, shipType);
    const grandTotal = subtotal + shippingFee;

    subtotalEl.innerText = subtotal;
    shippingEl.innerText = shippingFee;
    totalEl.innerText = grandTotal;
}

function openCheckout() {
    document.getElementById("checkout-form").style.display = "block";
}

function toggleShip() {
    const shipType = document.getElementById("shipType").value;
    document.getElementById("address-fields").style.display =
        shipType === "home" ? "block" : "none";
    document.getElementById("store-fields").style.display =
        shipType === "store" ? "block" : "none";

    renderCart();
}

function submitOrder() {
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const shipTypeEl = document.getElementById("shipType");
    const addressEl = document.getElementById("address");
    const storeNameEl = document.getElementById("storeName");
    const storeTypeEl = document.getElementById("storeType");
    const payTypeEl = document.getElementById("payType");

    if (!nameEl.value || !phoneEl.value || !shipTypeEl.value || !payTypeEl.value) {
        alert("請填寫完整資料");
        return;
    }

    if (shipTypeEl.value === "home" && !addressEl.value) {
        alert("請填寫宅配地址");
        return;
    }

    if (shipTypeEl.value === "store" && !storeNameEl.value) {
        alert("請填寫超商門市名稱");
        return;
    }

    const subtotal = Number(document.getElementById("subtotal").innerText);
    const shippingFee = Number(document.getElementById("shipping-fee").innerText);

    const order = {
        name: nameEl.value,
        phone: phoneEl.value,
        shipType: shipTypeEl.value,
        address: addressEl.value || "",
        storeType: storeTypeEl.value || "",
        storeName: storeNameEl.value || "",
        payType: payTypeEl.value,
        cart: getCart(),
        subtotal: subtotal,
        shippingFee: shippingFee,
        total: subtotal + shippingFee,
        time: new Date().toLocaleString()
    };

    localStorage.setItem("orderInfo", JSON.stringify(order));
    window.location.href = "pay.html";
}

renderCart();
</script>

</body>
</html>
